generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
}


enum UserRole {
  student
  faculty
}

enum PublishType {
  private
  organisation
  public
}

enum TestType {
  quiz
  coding
  summary
}

model User {
  id           String   @id @default(uuid()) @map("id")
  name         String   @map("name")
  phoneNo      String?  @map("phone_no")
  email        String   @unique @map("email")
  password     String   @map("password")
  university   String?  @map("university")
  collegeName  String?  @map("college_name")
  role         UserRole @map("role")
  verify       Boolean  @default(false)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  createdExams     Exam[]           @relation("created_exams")
  studentResponses Response[]       @relation("student_responses")
  facultyResponses Response[]       @relation("faculty_responses")
  facultyChannels  Channel[]        @relation("faculty_channels")
  sentDiscussions  Discussion[]     @relation("Sender")
  studentFeedbacks ExamFeedback[]   @relation("student_feedback")

  @@map("users")
}

model Channel {
  id          String   @id @default(uuid()) @map("id")
  name        String   @map("name")
  description String?  @map("description")
  facultyId   String?  @map("faculty_id")
  teamMembers String[] @default([]) @map("team_members")
  isPrivate   Boolean  @default(false) @map("is_private")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  faculty     User?        @relation("faculty_channels", fields: [facultyId], references: [id])
  exams       Exam[]
  discussions Discussion[]

  @@map("channels")
}

model Exam {
  id              String      @id @default(uuid()) @map("id")
  title            String      @map("title")
  domain          String?     @map("domain")
  questionCount   Int?        @map("question_count")
  isDuration      Boolean     @default(false)@map("is_duration")
  durationMinutes Int?        @map("duration_minutes")
  isStart         Boolean     @default(false)@map("is_start")
  startAt         DateTime?   @map("start_at")
  endAt           DateTime?   @map("end_at")
  questions       Json        @map("questions")
  testType        TestType    @map("test_type")
  publishType     PublishType @map("publish_type")
  organization    String?     @map("organization")
  instructions    Json?       @map("instructions")
  resultOut       Boolean     @default(true)@map("result_out")
  totalScore      Int         @default(0)@map("total_score")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  createdById String? @map("created_by_id")
  channelId   String? @map("channel_id")

  createdBy   User?            @relation("created_exams", fields: [createdById], references: [id])
  channel     Channel?         @relation(fields: [channelId], references: [id])
  responses   Response[]
  feedbacks   ExamFeedback[]


  @@map("exams")
}

model Response {
  id            String   @id @default(uuid()) @map("id")
  response      Json     @map("response")
  duration      Int      @default(0) @map("duration")
  violations    String[] @default([]) @map("violations")
  responseScore Float?   @map("response_score")
  totalScore    Int      @default(0)@map("total_score") 
  yourScore     Int      @default(0)@map("your_score")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  isAnalyses    Boolean  @default(false)@map("is_analysis")
  analyses      Json     @map("analyses")
  isTerminated  Boolean  @default(false)@map("is_terminated")
  terminatedReason String? @map("terminated_reason")
  facultyReview String?  @map("faculty_review")
  examId    String  @map("exam_id")
  studentId String? @map("student_id")
  facultyId String? @map("faculty_id")
  exam     Exam?  @relation(fields: [examId], references: [id], onDelete: Cascade)
  student  User?  @relation("student_responses", fields: [studentId], references: [id])
  faculty  User?  @relation("faculty_responses", fields: [facultyId], references: [id])

  @@map("responses")
}


model Discussion {
  id        String   @id @default(uuid()) @map("id")
  message   String   @map("message")
  sendBy    String   @map("send_by")
  channelId String   @map("channel_id")
  sendAt    DateTime @default(now()) @map("send_at")

  sendUser  User?     @relation("Sender", fields: [sendBy], references: [id])
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([sendBy])
  @@index([sendAt])
}
model ExamFeedback {
  id         String   @id @default(uuid()) @map("id")
  message    String   @map("message")
  rating     Int      @map("rating")
  examId     String   @map("exam_id")
  studentId  String   @map("student_id")
  createdAt  DateTime @default(now()) @map("created_at")

  exam     Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  student  User     @relation("student_feedback", fields: [studentId], references: [id])

  @@map("exam_feedbacks")
}